\documentclass[gradu, twoside]{tktltiki}
\usepackage{amsmath}
\usepackage{url}
\begin{document}

\title{Vakaan avioliiton ongelman ja sen muunnelmien aikavaativuuksia}
\author{Jani Rahkola}
\date{\today}
\level{}

\maketitle

\doublespacing

\faculty{Matemaattis-luonnontieteellinen}
\department{Tietojenkäsittelytieteen laitos}
\subject{Tietojenkäsittelytiede}

\begin{abstract}
  Vakaan avioliiton ongelmassa miesten joukon $M$ ja naisten joukon
  $N$ välille pyritään löytämään relaatio $\mu \subset M \times N$
  noudattaen miesten ja naisten mieltymyksiä kuvaavia täydellisiä
  järjestysrelaatioita $P_M = \{P_m \subset N \times N | m \in M\}$ ja
  $P_N = \{P_n \subset M \times M | n \in N\}$. Gale ja Shapley
  antavat ongelman esittelyn yhteydessä algoritmin joka ratkaisee
  ongelman ajassa $O(n^2)$. Ng osoittaa, että Galen ja Shapleyn
  algoritmi on suoritusajaltaan optimaalinen.

  Käytännön kannalta on usein tarpeellista muokata ongelmanasettelua
  niin, että järjestysrelaatioiden ei tarvitse kattaa koko vastakkaisen
  sukupuolen joukkoa, tai niissä on luvallista olla tasatilanteita.
  Molemmat näistä muunnoksista voidaan ratkaista ajassa $O(n^2)$, mutta
  yhdessä ne tekevät ongelmasta NP-täydellisen.
\end{abstract}

\mytableofcontents

\section{Johdanto}

Gale ja Shapley määrittelevät vakaan avioliiton ongelman (stable
marriage problem) artikkelissaan College Admissions and the Stability
of Marriage \cite{galeshapley62} jossa he esittävät ratkaisun
yliopistojen valintaongelmaan. Vakaan avioliiton ongelma on
yksinkertaistettu tilanne, jossa joukosta naisia ja miehiä pyritään
muodostamaan pareja noudattaen sekä miesten että naisten mieltymyksiä.
Gale ja Shapley määrittelevät vakauden (stability) ja optimaalisuuden
käsitteen kuvaamaan hyviä ratkaisuja ongelmaan.

Ensimmäisessä luvussa annan määritelmän vakaan avioliiton ongelmalle,
ratkaisun vakaudelle ja sen optimaalisuudelle. Seuraavassa luvussa
esittelen Galen ja Shapleyn esittelemän algoritmin ratkaisun
löytämiseksi. Saman luvun lopussa käyn läpi analyysin algoritmin
suoritusajasta. Kolmannessa luvussa esittelen tuloksen joka osoittaa
Galen ja Shapleyn algoritmin olevan suoritusajaltaan optimaalinen.

Päätösluvussaan Gale ja Shapley toteavat luomansa vakaan avioliiton
ongelman olevan hyvin teoreettinen ja kaukana alkuperäisestä
yliopistojen valintaongelmasta. Ongelman ja sen ratkaisun
sovellettavuutta voidaan kuitenkin parantaa luopumalla joistakin
alkuperäisen määrittelyn oletuksista. Neljäs luku käsittelee
muunnelmaa, jossa naisilla ja miehillä on mahdollisuus ilmaista
olevansa yhtä mieltyneitä kahteen tai useampaan vastakkaisen
sukupuolen edustajaan. Tämä muunnelma voidaan ratkaista muokkaamalla
Galen ja Shapleyn algoritmia suoritusajan pysyessä muuttumattomana
\cite{manlove02}. Viidennessä luvussa käsittelen muunnelmaa jossa
miehillä ja naisilla on mahdollisuus ilmoittaa etteivät he missään
tapauksessa halua muodostaa paria joidenkin vastakkaisen sukupuolen
edustajien kanssa. Myös tämän ongelman ratkaisuun on suoritusajaltaan
muuttumaton muunnelma Galen ja Shapleyn algoritmista
\cite{gusfield89}.

Mainitut kaksi muunnelmaa mahdollistavat niitä koskevien tulosten
soveltamisen moniin käytännön ongelmiin \cite{manlove02}. Kuudennessa
luvussa käsittelen muunnelmien yhdistelmää, jonka ratkaiseminen on
ongelmana NP-täydellinen \cite{manlove02}.

\section{Vakaan avioliiton ongelma}

Määritellään vakaan avioliiton ongelma seuraavasti. Olkoon $M$ joukko
miehiä ja $N$ joukko naisia. Olkoon lisäksi $P_M = \{P_m \subset N
\times N | m \in M\}$ ja $P_N = \{P_n \subset M \times M | n \in N\}$
joukot täydellisiä järjestysrelaatioita jotka kertovat mihin
järjestykseen mies $m$ (vastaavasti nainen $n$) sijoittaa vastakkaisen
sukupuolen edustajat. Kutsutaan näitä relaatioita
\emph{preferenssirelaatioiksi}. Jos siis $m_1,m_2 \in M$ ja
$m_1P_nm_2$ pitää nainen $n$ enemmän miehestä $m_1$ kuin $m_2$. Nyt
nelikko $(M, N, P_M, P_N)$ määrittelee vakaan avioliiton ongelman.

Nyt relaatiota $\mu \subset M \times N$ kutsutaan \emph{sijoitteluksi},
jos $\forall m \in M: \exists n \in N: (m, n) \in \mu$ ja vastaavasti
$\forall n \in N: \exists m \in M: (m, n) \in \mu$. Tapauksessa jossa
$|M| = |N|$ on $\mu$ bijektio, joten olkoon $\mu(m)$ miehen $m$ pari
sijoittelussa $\mu$ ja vastaavasti $\mu^{-1}(n)$ naisen $n$ pari.

Vakaan avioliiton ongelman ratkaiseminen tarkoittaa relaation $\mu$
määräämistä niin että se on vakaa. Sijoittelu on \emph{epävakaa}, jos
joillakin $m_1, m_2 \in M$ ja $n_1, n_2 \in N$ pätee, että $(m_1, n_1)
\in \mu$ ja $(m_2, n_2) \in \mu$ mutta $n_1P_{m_2}n_2$ ja
$m_2P_{n_1}m_1$. Siis mies $m_2$ pitää enemmän naisesta $n_1$ kuin
paristaan $n_2$, ja nainen $n_1$ pitää enemmän miehestä $m_2$ kuin
paristaan $m_1$. Sijoittelua voitaisiin siis parantaa $m_2$:n ja
$n_1$:n kannalta määräämällä $(m_2, n_1) \in \mu$.

\section{Ratkaisu ajassa $\boldsymbol{\Theta(n^2)}$}

Jokaiseen vakaan avioliiton ongelmaan on olemassa vakaa ratkaisu
\cite{galeshapley62}. Gale ja Shapley todistavat tämän antamalla
seuraavanlaisen algoritmin vakaan sijoittelun löytämiseen.
Ensimmäisellä kierroksella jokainen mies kosii naista josta hän pitää
eniten. Naiset valitsevat alustavasti mahdollisista kosijoistaan sen
josta he pitävät eniten. Seuraavilla kierroksilla valitsematta jääneet
miehet kosivat listallaan seuraavana olevia naisia, ja naiset
valitsevat kosijoistaan ja mahdollisesta alustavasti valitusta
miehestä jälleen sen josta he pitävät eniten. Näin jatketaan kunnes
jokaista naista on kosittu ainakin kerran, jolloin muodostuneet parit
voidaan vahvistaa.

Jos jokaista naista on kosittu ainakin kerran, ei yksikään mies ole
tullut enää torjutuksi. Jos joku mies olisi tullut torjutuksi, olisi
joku nainen saanut useamman kuin yhden kosinnan, jolloin joku naisista
olisi jäänyt ilman kosintaa. Siispä algoritmi on määrännyt parin
jokaiselle miehelle ja naiselle kun jokaista naista on kosittu ainakin
kerran.

Algoritmin antama sijoittelu on vakaa \cite{galeshapley62}. Oletetaan,
että saatu sijoittelu on epävakaa ja on siis olemassa $m \in M$ ja $n
\in N$ joilla $(m, n) \notin \mu$, mutta $nP_m\mu(m)$ ja
$mP_n\mu^{-1}(n)$. Koska $m$ pitää enemmän naisesta $n$ kuin
paristaan, on hänen täytynyt kosia naista $n$ ennen pariaan. Koska $m$
ja $n$ eivät kuitenkaan ole pari, on naisen $n$ täytynyt torjua
kosinta. Nainen $n$ pitää siis enemmän paristaan kuin miehestä $m$.
Tämä on kuitenkin ristiriita. Siis saatu sijoittelu on vakaa.

Galen ja Shapleyn algoritmi ei vaadi, että naisten ja miesten joukot
ovat yhtämahtavat. Mikäli $|M| < |N|$ päättyy algoritmi kun $|M|$
kappaletta naisia on saanut kosinnan. Vastaavasti jos $|N| < |M|$,
päättyy algoritmi kun jokainen mies on tullut alustavasti valituksi
tai jokaisen naisen torjumaksi. \cite{galeshapley62}

\subsection{Pareto-optimaalisuus}

Galen ja Shapleyn algoritmin antama sijoittelu $\mu$ on miesten
kannalta \emph{heikosti Pareto-optimaalinen} \cite{gusfield89}. Ei
siis ole olemassa toista sijoittelua $\gamma$ jossa kaikilla $(m, n)
\in \gamma$ pätee, että $nP_m\mu(m)$. Vastaavasti voidaan määritellä,
että sijoittelu on heikosti Pareto-optimaalinen naisten kannalta.
Luonnollista on, että algoritmi antaa naisoptimaalisen sijoittelun,
kun kosijoiden rooli annetaan naisille.

\subsection{Yläraja $\boldsymbol{O(n^2)}$}

Gale ja Shapley kirjoittavat algoritmin päättyvän korkeintaan $n^2 -
2n + 2$ kierroksen jälkeen \cite{galeshapley62}. Asia esitetään
kuitenkin vain sivuhuomautuksena, eivätkä kirjoittajat ota kantaa
algoritmin varsinaiseen aikavaativuuteen. Kierrosten määrä ei anna
suoraan aihetta odottaa $O(n^2)$ aikavaativuutta, sillä yhden
kierroksen aikana voi tapahtua useita kosintoja. Ei siis ole selvää,
että yksi kierros on mahdollista suorittaa vakioajassa.

Gusfield ja Irving esittävät algoritmille muotoilun \cite{gusfield89}
jonka analysointi on alkuperäistä helpompaa. Siinä yhden kierroksen
aikana yksi mies kosii naista josta pitää eniten ja jota hän ei ole
vielä kosinut. Gusfiel ja Irving osoittavat että yksi kosinta voidaan
suorittaa vakioajassa \cite{gusfield89}. Nyt riittää tarkastella
kosintojen määrää joka tapauksessa $|M| = |N| = n$ on korkeintaan
$n^2$, sillä jokainen mies kosii jokaista naista korkeintaan kerran
\cite{gusfield89}. Tästä seuraa algoritmin suorituksen asymptoottinen
yläraja $O(n^2)$.

\subsection{Alaraja $\boldsymbol{\Omega(n^2)}$}

Koska kummankin sukupuolen preferenssirelaatioiden esittäminen vaatii
$O(n^2)$ muistia, vie syötteen luku itsessään jo $\Omega(n^2)$ ajan.
Niinpä alarajan tarkastelussa on mielekästä tutkia tilannetta jossa
algoritmin syöte on jo valmiiksi luettu muistiin \cite{cheng89}.

Ng osoittaa, että Galen ja Shapleyn algoritmi on asymptoottiselta
aikavaativuudeltaan optimaalinen \cite{cheng89}. Ngin päätuloksen
mukaan satunnaisesta mies-nainen -parista voidaan päätellä onko se
vakaa annetussa ongelmassa ajassa $\Omega(n^2)$. Tästä seuraa, että
vakaan avioliiton ongelman ratkaiseminen on asymptoottiselta
aikavaativuudeltaan $\Theta(n^2)$ \cite{cheng89}. Jos jokin algoritmi
löytäisi vakaan sijoittelun alle $\Theta(n^2)$ ajassa, päättelisi se
myös sijoitteluun kuuluvien parien vakauden alle $\Omega(n^2)$ ajassa
mikä olisi ristiriita. Toisin kuin Gusfieldin ja Irvinig analyysi
algoritmin ylärajasta, Ng olettaa, että naisten ja miesten joukot ovat
yhtämahtavat.

Ng analyysi tarkastelee sitä kuinka monta kertaa mikä tahansa vakaan
avioliiton ongelmaa ratkaiseva algorimi joutuu tarkastelemaan
syötteenään saatua ongelman kuvausta. Ng aloittaa kanonisesta
ongelmasta jossa tutkittava pari on vakaa. Sitten hän esittää
menetelmän jolla voidaan muodostaa tästä ongelmasta muunnelmia joissa
tutkittava pari ei ole vakaa. Nyt tunnistaakseen onko pari vakaa
syötteenä annetussa ongelmassa, tulee algoritmin kyetä erottamaan
kanoninen ongelma siitä luoduista muunnelmista. Ng osoittaa tähän
tarvittavan ainakin $\Omega(n^2)$ ongelman kuvauksen tarkastelua.
\cite{cheng89}

\section{Ei-refleksiiviset preferenssirelaatiot}

Galen ja Shapleyn määrittelemässä vakaan avioliiton ongelmassa
molemmat sukupuolet määrittelevät kiinnostuksensa kaikista
vastakkaisen sukupuolen henkilöistä. Käytännön sovelluksissa tämä ei
kuitenkaan ole aina haluttua. Esimerkiksi oppilaitosten valinnoissa
hakijat eivät ole halukkaita opiskelemaan missä tahansa
oppilaitoksessa eivätkä oppilaitokset halua ottaa vastaan ketä tahansa
hakijaa.

Näin syntyy muunnelma vakaan avioliiton ongelmasta jossa
preferenssirelaatioiden ei tarvitse olla refleksiivisiä. Tästä seuraa,
että ne eivät myöskään ole täydellisiä tai edes järjestysrelaatioita.
Ne eivät siis välttämättä anna järjestystä kaikille vastakkaisen
sukupuolen henkilöille. Antisymmetrisyys ja transitiivisuus kuitenkin
säilyvät. Lisäksi sijoittelulle $\mu$ tulee päteä, että jos $m \in M$,
$n \in N$ ja $(m, n) \in \mu$ niin $(n, n) \in P_m$ ja $(m, m) \in
P_n)$. Siis jos mies $m$ ja nainen $n$ ovat pari, ovat nainen ja mies
esittäneet mieltymyksensä toisistaan.

Tästä seuraa, että saatu sijoittelu voi olla osittainen sillä jokainen
mies ja nainen eivät välttämättä saa itselleen paria. Tästä syystä on
tarpeen muotoilla heikompi versio vakaudesta. Sijoittelu on
\emph{heikosti epävakaa}, jos on olemassa $m_1 \in M$ ja $n_1 \in N$
joilla seuraavat ehdot ovat voimassa \cite{gusfield89}:
\[
\text{1. }(m_1, n_1) \notin \mu \text{, mutta } (m_1, m_1) \in P_{n_1}
\text{ ja } (n_1, n_1) \in P_{m_1}
\]
\[
\text{2. Jos }\exists n_2 \in N: (m, n_2) \in \mu \text{, niin
}n_1P_{m_1}n_2
\]
\[
\text{3. jos }\exists m_2 \in M: (m_2, n) \in \mu \text{, niin
}m_1P_{n_1}m_2
\]

Myös Pareto-optimaalisuus voidaan laajentaa koskemaan
ei-refleksiivisillä järjestysrelaatioilla saatua sijoittelua. Jokainen
mies pitää parempana sijoittelua jossa hänellä on pari, kuin
sijoittelua jossa hänellä ei ole paria. \cite{gusfield89}

Esitellyn muunnelman ratkaisemiseksi täytyy myös Galen ja Shapleyn
algoritmiin tehdä muunnos. Jokaisen miehen ja naisen
preferenssirelaatiot esikäsitellään seuraavasti. Kaikille $m \in M$ ja
$(n_1, n_1) \in P_m$ tarkistetaan onko $(m, m) \in P_{n_1}$. Jos ei,
poistetaan $(n_1, n_2)$ $P_m$:stä kaikilla $n_2 \in N$. Vastaava
tehdään kaikille $n \in N$. Siis jokaisen miehen ja naisen
preferenssirelaatiosta poistetaan ne parit jotka koskevat sellaista
vastakkaisen sukupuolen edustajaa, joka ei halua muodostaa paria ko.
miehen/naisen kanssa. Tämä esikäsittely voidaan tehdä ajassa $O(n^2)$
kun henkilön kuuluminen toisen henkilön preferenssirelaatioon voidaan
tarkistaa vakioajassa. Tämä voidaan taata valitsemalla
preferenssirelaatioiden esitys sopivasti \cite{gusfield89}. Nyt
muunnettu ongelma voidaan ratkaista Galen ja Shapleyn algoritmilla
kunhan vain tehdään mahdolliseksi algoritmin pysähtyminen vaikka
kaikilla miehillä ja naisilla ei olisi paria.

\section{Ei-antisymmetriset preferenssirelaatiot}

Monissa käytännön sovelluksissa ei ole aina haluttua määritellä
järjestystä kaikkien vastakkaisen osapuolen toimijoiden välille.
Esimerkiksi oppilaitosten valinnoissa jonkin rajan alle jääneistä
hakijoista valinta saatetaan tehdä esimerkiksi arpomalla. Jaettaessa
toimistoja työtekijöille voi työntekijällä olla vain muutama
vaihtoehto joihin hän erityisesti haluaa. Erona osittaisiin
preferenssirelaatioihin on kuitenkin se, että toimijat ovat kuitenkin
valmiita muodostamaan parin kenen tahansa vastapuolen toimijan kanssa.

Näin saadussa muunnelmassa preferenssirelaatiot eivät ole
antisymmetrisiä eivätkä siten myöskään järjestysrelaatioita. Ne ovat
kuitenkin refleksiivisiä ja transitiivisia. Voi siis olla niin, että
jos $m \in M$, $n_1,n_2 \in N$ ja $n_1 \neq n_2$, niin$n_1P_mn_2$ ja
$n_2P_mn_1$ ovat voimassa yhtä aikaa. Muunnelman mukaiset ongelmat
voidaan kuitenkin ratkaista alkuperäistä Galen ja Shapleyn algoritmia
käyttäen, jos tasatilanteet ratkaistaan satunnaisesti
\cite{gusfield89}.

Myös tässä muunnelmassa on tarpeen määritellä heikompi versio
vakaudesta. Esimerkiksi täydellisen väliinpitämättömyyden vallitessa
mikään sijoittelu ei olisi vakaa, sillä jokaisen kahden parin
tapauksessa henkilöille olisi mieluista muodostaa parit vaihtamalla
miehiä (tai naisia). Olkoon siis ei-antisymmetristen
preferenssirelaatioiden tapauksessa sijoittelu $\mu$ \emph{heikosti
  vakaa}, jos on olemassa $m \in M$ ja $n \in N$ joilla $(m, n) \notin
\mu$, mutta $nP_m\mu(m)$, $mP_n\mu^{-1}(n)$ ja $\mu(m)\not P_mn$,
$\mu^{-1}\not P_nm$. Siis riittää, että on olemassa yksi nainen ja
mies, jotka pitävät aidosti enemmän toisistaan kuin sijoittelun
antamasta paristaan.

Käytännön ongelmissa tasatilanteiden ratkaiseminen arvalla on usein
hyväksyttävää. Siitä seuraa kuitenkin, että algoritmi saattaa antaa
eri suorituskerroilla eri tuloksen. Nyt kaikkia algoritmin tuottamia
sijoitteluja voisi luonnehtia heikosti Pareto-optimaalisiksi, mutta
käsitteen määrittelyä täytyy muuttaa, sillä se ei salli useita
optimaalisia sijoitteluja.

Olkoon siis ei-antisymmetristen preferenssirelaatioiden tapauksessa
sijoittelu $\mu$ \emph{heikosti Pareto-optimaalinen} jos ei ole
olemassa toista sijoittelua $\gamma$ jossa kaikilla $(m, n) \in
\gamma$ pätee, että $nP_m\mu(m)$ ja $\mu(m)\not P_mn$. Siis
sijoittelussa $\gamma$ kaikki miehet pitäisivät aidosti enemmän
paristaan kuin sijoittelussa $\mu$.

\section{Ei-refleksiiviset ja ei-antisymmetriset preferenssirelaatiot}

Oppilaitosten valinnoissa on mielekästä tutkia myös kahden edellä
esitellyn muunnelman yhdistelmää. Siinä toimijoiden
preferenssirelaatiot voivat siis olla sekä osittaisia, että
ei-antisymmetrisiä. Esimerkiksi tietyn rajan ylittäneet hakijat
olisivat listan kärkipäässä, jonkin toisen rajan alittaneet eivät
voisi missään tapauksessa tulla valituiksi oppilaitokseen, ja väliin
jääneiden tapauksessa valinta kahden hakijan välillä ratkaistaisiin
aina arvalla.

Tässä muunnelmassa ensimmäinen merkittävä huomio on, että kaikki
mahdolliset vakaat sijoittelut eivät välttämättä ole saman kokoisia.
Tämä voidaan todeta yksinkertaisen esimerkin avulla. Olkoon $m_1:
n_1$, $m_2: n_1 n_2$, $n_1: (m_1 m_2)$ ja $n_2: m_2$. Tässä siis
miellyttävin henkilö on listassa vasemmanpuolimmaisena ja sulut
kuvaavat tasatilannetta. Nyt $\{(m_2, n_1)\}$ ja $\{(m_1, n_1), (m_2,
n_2)\}$ ovat vakaita sijoitteluja. \cite{manlove02}

Koska vakaat sijoittelut voivat olla eri kokoisia, on mielenkiintoista
pyrkiä löytämään suurimmat tai pienimmät vakaat sijoittelut. Molemmat
näistä ongelmista ovat kuitenkin NP-täydellisiä jopa erittäin
rajoitetussa tapauksessa jossa tasatilanteet ovat sallittuja vain
kahden vähiten miellyttävimmän henkilön välillä. Siis jokaisessa
preferenssirelaatiossa voi olla korkeintaan yksi tasatilanne
\cite{manlove02}. Manlove ja kumppanit todistavat tämän tekemällä
reduktion suurimman vakaan sijoittelun löytämisestä exact maximal
matching ongelmaan ja pienimmän vakaan sijoittelun löytämisestä
minimum maximal matching ongelmaan.

\section{Yhteenveto}

Olen esitellyt vakaan avioliiton ongelman ja sen ratkaisun
aikavaativuuksia Galen ja Shapleyn esittelemässä muodossa sekä
kolmessa käytännön kannalta merkittävässä muunnelmassa.
Ei-refleksiiviset ja ei-antisymmetriset preferenssirelaatiot yhdistävä
ongelman on osoitettu olevan NP-täydellinen. Tämä on tarpeellista
ottaa huomioon monissa vakaan avioliiton ongelman yleistyksissä, kuten
oppilaitosten valinnassa. Käytännön sovelluksissa ainakin toisen
osapuolen toimijoiden määrä on usein erittäin suuri, esimerkiksi
Suomen toisen asteen oppilaitosten yhteishaussa haki vuoden 2011
keväällä yli 102 000 hakijaa \cite{OPH12}.

\begin{thebibliography}{XXX99}

\bibitem[GaS62]{galeshapley62}
  D. Gale, L. S. Shapley.
  College Admissions and the Stability of Marriage.
  \emph{The American Mathematical Monthly, 69, 1 (1962)}

\bibitem[MII02]{manlove02}
  David F. Manlove, Robert W. Irving, Kazuo Iwama, Shuichi Miyazaki,
  Yasufumi Morita.
  Hard variants of stable marriage.
  \emph{Theoretical Computer Science, 276, (2002), sivut 261-279}

\bibitem[GuI89]{gusfield89}
  D. Gusfield, Robert W. Irving.
  The Stable Marriage Problem: Structure and Algorithms.
  \emph{MIT Press, Cambridge, MA, 1989}

\bibitem[Che89]{cheng89}
  Cheng Ng.
  Lower Bounds for the Stable Marriage Problem and its Variants.
  \emph{30th Annual Symposium on Foundations of Computer Science,
    (1989), sivut 129-133}

\bibitem[OPH12]{OPH12}
  Opetushallitus.
  Aloituspaikat, hakijat, hyväksytyt ja paikan vastaanottaneet kevään
  2011 ammatillisen ja lukiokoulutuksen yhteishaussa.
  \url{https://www.kouluta.fi/koulutadw/faces/app/startupDWReports.jspx?report_id=18}
      [3.3.2012]

\end{thebibliography}
\end{document}
